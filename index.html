<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta KML – Versi Lengkap + OTDR (ODC→ODP) + Layer Toggle + Ukur Titik</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.css" />

  <style>
    body { margin: 0; font-family: sans-serif; }
    header { background: #111827; color: #fff; padding: .5rem 1rem; font-size: 1rem; font-weight: bold; }
    .wrap { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 40px); }
    .sidebar { border-right: 1px solid #ccc; padding: .5rem; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .group { margin-bottom: .9rem; }
    .group label { display:block; font-size:.85rem; margin-bottom:.25rem; font-weight:600; }
    select, input, button { width: 100%; padding: .5rem; margin-bottom: .25rem; }
    button { background:#111827; color:#fff; border:none; cursor:pointer; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; }
    .log { font-family: monospace; font-size:.8rem; white-space: pre-wrap; max-height:220px; overflow:auto; border:1px solid #ddd; padding:.25rem; }
    .muted { color:#6b7280; font-size:.8rem; }
  </style>
</head>
<body>
  <header>Peta KML – Leaflet + OTDR (ODC→ODP)</header>
  <div class="wrap">
    <aside class="sidebar">
      <div class="group">
        <label for="kmlFiles">Muat file KML (bisa pilih lebih dari satu)</label>
        <input type="file" id="kmlFiles" accept=".kml" multiple />
        <div class="muted">Setiap file akan jadi layer terpisah yang bisa di-ON/OFF.</div>
      </div>

      <div class="group">
        <label for="routeSelect">Pilih Rute (ODC → ODP) untuk OTDR</label>
        <select id="routeSelect"></select>
        <label for="otdrMeter">Jarak OTDR (meter)</label>
        <input type="number" id="otdrMeter" placeholder="Misal 1240" />
        <button id="btnFindBreak">Temukan Titik Putus</button>
      </div>

      <div class="group">
        <label>Ukur dari Titik Bernama ke Titik Bernama</label>
        <div class="row">
          <select id="ptFrom"></select>
          <select id="ptTo"></select>
        </div>
        <input type="number" id="breakNote" placeholder="Keterangan putus (meter) — opsional" />
        <button id="btnMeasure">Ukur & Tandai</button>
        <div class="muted">Jarak garis lurus (geodesik). Untuk jarak sepanjang jalur, gunakan fitur OTDR di atas.</div>
      </div>

      <div class="group">
        <label>Status & Log</label>
        <div id="log" class="log"></div>
      </div>
    </aside>
    <main>
      <div id="map"></div>
    </main>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <script src="https://unpkg.com/leaflet-measure@3.3.0/dist/leaflet-measure.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // ====== peta ======
    const map = L.map('map').setView([-7.6, 112.9], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    L.control.measure().addTo(map);

    // ====== state ======
    const routes = [];           // {id, line, lenKm, startName, endName}
    const allPoints = [];        // {name, lat, lng}
    const overlayLayers = {};    // {filename: L.LayerGroup}
    let breakMarker = null;
    let measureLine = null;

    // ====== log util ======
    const logEl = document.getElementById('log');
    const log = (msg) => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };

    // ====== layer control ======
    const layerControl = L.control.layers({}, {}, {collapsed:false}).addTo(map);

    function upsertLayerGroup(name){
      if(!overlayLayers[name]){
        overlayLayers[name] = L.layerGroup().addTo(map);
        layerControl.addOverlay(overlayLayers[name], name);
      }
      return overlayLayers[name];
    }

    // ====== render dropdowns ======
    function renderRouteSelect(){
      const sel = document.getElementById('routeSelect');
      sel.innerHTML = '';
      routes.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = `${r.startName} → ${r.endName} (${(r.lenKm*1000).toFixed(0)} m)`;
        sel.appendChild(opt);
      });
    }

    function renderPointSelects(){
      const fromSel = document.getElementById('ptFrom');
      const toSel = document.getElementById('ptTo');
      const names = Array.from(new Set(allPoints.map(p=>p.name))).sort();
      fromSel.innerHTML = ''; toSel.innerHTML='';
      names.forEach(n=>{
        const o1=document.createElement('option'); o1.value=n; o1.textContent=n; fromSel.appendChild(o1);
        const o2=document.createElement('option'); o2.value=n; o2.textContent=n; toSel.appendChild(o2);
      });
    }

    // ====== helper nearest point name (untuk ujung rute) ======
    function findNearestPointName(coord, radiusMeters = 250){
      const target = turf.point(coord);
      let best=null, min=Infinity;
      allPoints.forEach(p=>{
        const d=turf.distance(target, turf.point([p.lng,p.lat]), {units:'meters'});
        if(d<min && d<=radiusMeters){ min=d; best=p.name; }
      });
      return best || null;
    }

    // ====== aksi UI ======
    document.getElementById('btnFindBreak').addEventListener('click', () => {
      const sel = document.getElementById('routeSelect');
      const r = routes.find(x => x.id === sel.value);
      if (!r) { log('Rute tidak dipilih'); return; }
      const m = Number(document.getElementById('otdrMeter').value);
      if (!(m>=0)) { log('Masukkan jarak OTDR valid'); return; }
      const km = Math.min(m/1000, r.lenKm);
      const pt = turf.along(r.line, km, {units:'kilometers'});
      const [lng,lat] = pt.geometry.coordinates;
      if (breakMarker) map.removeLayer(breakMarker);
      breakMarker = L.marker([lat,lng]).addTo(map).bindPopup(`Titik putus ${m} m pada ${r.startName} → ${r.endName}`).openPopup();
      map.flyTo([lat,lng], 17);
      log(`Titik putus ditandai: ${m} m pada rute ${r.startName} → ${r.endName}`);
    });

    document.getElementById('btnMeasure').addEventListener('click', () => {
      const fromName = document.getElementById('ptFrom').value;
      const toName = document.getElementById('ptTo').value;
      const note = document.getElementById('breakNote').value;
      const p1 = allPoints.find(p=>p.name===fromName);
      const p2 = allPoints.find(p=>p.name===toName);
      if(!p1 || !p2){ log('Titik tidak lengkap'); return; }
      const line = turf.lineString([[p1.lng,p1.lat],[p2.lng,p2.lat]]);
      const meters = turf.length(line,{units:'kilometers'})*1000;
      if (measureLine) map.removeLayer(measureLine);
      measureLine = L.polyline([[p1.lat,p1.lng],[p2.lat,p2.lng]], {color:'#2563eb'}).addTo(map);
      const mid = turf.midpoint(turf.point([p1.lng,p1.lat]), turf.point([p2.lng,p2.lat]));
      const [mlng, mlat] = mid.geometry.coordinates;
      L.marker([mlat, mlng]).addTo(map).bindPopup(`ODP/ODC: ${fromName} → ${toName}<br>Jarak ≈ ${meters.toFixed(0)} m${note?`<br>Putus: ${Number(note).toFixed(0)} m`:''}`).openPopup();
      map.fitBounds(measureLine.getBounds().pad(0.2));
      log(`Ukur: ${fromName} → ${toName} = ${meters.toFixed(0)} m${note?` | Putus ${Number(note).toFixed(0)} m`:''}`);
    });

    // ====== load banyak KML ======
    document.getElementById('kmlFiles').addEventListener('change', async (ev) => {
      const files = ev.target.files;
      for (const file of files) {
        const text = await file.text();
        const kml = new DOMParser().parseFromString(text, 'text/xml');
        const geojson = toGeoJSON.kml(kml);

        const group = upsertLayerGroup(file.name);
        const gLayer = L.geoJSON(geojson, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius:6}),
          onEachFeature: (f, l) => {
            if (f.geometry.type === 'Point') {
              const nm = f.properties.name || 'Titik';
              l.bindPopup(nm);
              allPoints.push({ name: nm, lat: l.getLatLng().lat, lng: l.getLatLng().lng });
            }
          }
        }).addTo(group);

        // Deteksi rute (LineString saja untuk sederhana)
        geojson.features.forEach((f, idx) => {
          if (f.geometry.type === 'LineString') {
            const coords = f.geometry.coordinates;
            const start = coords[0];
            const end = coords[coords.length-1];
            const startName = findNearestPointName(start) || 'ODC';
            const endName = findNearestPointName(end) || 'ODP';
            const line = turf.lineString(coords);
            const lenKm = turf.length(line, {units:'kilometers'});
            routes.push({id:`${file.name}-r${idx}`, line, lenKm, startName, endName});
          }
        });

        // Fit bounds kelompok layer file ini
        try { map.fitBounds(gLayer.getBounds().pad(0.2)); } catch(_){ }
      }
      renderRouteSelect();
      renderPointSelects();
      log(`${files.length} file KML dimuat, total rute: ${routes.length}, total titik: ${allPoints.length}`);
    });
  </script>
</body>
</html>
